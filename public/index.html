<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>GeoJSON Filter Splitter</title>

    <meta name="description" content="Source code generated using layoutit.com">
    <meta name="author" content="LayoutIt!">
	<link rel="icon" href="img/icon.ico">
    <link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="css/style.css" rel="stylesheet">
	

  </head>
  <script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/scripts.js"></script>
  <!--<script src="js/app.js"></script>-->
  
  <body>

    <div class="container-fluid">
	<div class="row">
		<div class="offset-md-1 col-md-10">
			<br>
			<div class="input-group">
				<h3>
					GeoJSON Filter Splitter Tool
				</h3><hr>
				<button id="exitBtn" class="btn btn-danger">
					Exit
				</button>
			</div>
			<p>
				Use this tool to help troubleshoot your GeoJSON files. You can export small subsets of data when working with large files to understand the attributes. You can export subsets of data based on certain filters.
				You can export GeoJSON as a flattened Tab text file and you can host your exported file to make them available to other webservices.
				Exported files are available as Physical: /public/exports/filename URL: host/exports/filename 
			</p>
			<p><h5>File Selection</h5></p>
			<form id="file_submit" enctype="multipart/form-data">
				<div class="form-group">
					<input type="file" class="form-control-file" id="InputFile">
				</div>
				<div class="form-group">
					<label for="InputSample">
						Sample Size
					</label>
					<input type="number" class="form-control col-sm-1" id="InputSample" value="10">
				</div>
				<button type="submit" class="btn btn-primary">
					Upload
				</button>
			</form>
			<p>Sample</p>
			<div id="sampleData" class="table-responsive">
			</div>
			<br>
			<p><h5>Split and Filter your exported file.</h5></p>
			<form id="filter_submit">
				<div class="form-group">
				<label for="InputKeyname">
						Keyname (optional)
					</label>
					<input type="text" class="form-control col-md-3" id="InputKeyname">
				</div>
				<div class="form-group">
					 
					<label for="InputKeyValue">
						Key Value (optional)
					</label>
					<input type="text" class="form-control col-md-3" id="InputKeyValue">
				</div>
				<div class="form-group">
					 
					<label for="InputLimit">
						Limit Export Count
					</label>
					<input type="number" class="form-control col-sm-1" id="InputLimit" value="0">
				</div>
				<div>
					<label class="radio-inline">
						<input type="radio" name="InputExport" value=1 checked>Filter
					</label>
					<label class="radio-inline">
						<input type="radio" name="InputExport" value=2>Filter & Export
					</label>
					<label class="radio-inline">
						<input type="radio" name="InputExport" value=3>Filter & Export Separate Files
					</label> 
				</div> 
				<div class="checkbox checkbox-primary">
					<input type="checkbox" class="styled" id="InputGeoTab">
					<label for="InputGeoTab">
						Export as Geo Tab File
					</label>
				</div>
				<button type="submit" class="btn btn-primary">
					Submit
				</button>
			</form>
		</div>
	</div>
	<div class="row">
		<div class="offset-md-1 col-md-10">
			<div id="msg"></div>
		</div>
	</div>

</div>
<script>

	function CreateTableFromJSON(sampleArray) {
			
		// EXTRACT VALUE FOR HTML HEADER. 
		// ('Book ID', 'Book Name', 'Category' and 'Price')
		var col = [];
		for (var i = 0; i < sampleArray.length; i++) {
			for (var key in sampleArray[i]) {
				if (col.indexOf(key) === -1) {
					col.push(key);
				}
			}
		}



		// CREATE DYNAMIC TABLE.
		var table = document.createElement("table");
		table.setAttribute("class","table table-striped w-auto wordwrap")

		// CREATE HTML TABLE HEADER ROW USING THE EXTRACTED HEADERS ABOVE.

		var tr = table.insertRow(-1);                   // TABLE ROW.

		for (var i = 0; i < col.length; i++) {
			var th = document.createElement("th");      // TABLE HEADER.
			th.innerHTML = col[i];
			tr.appendChild(th);
		}

		// ADD JSON DATA TO THE TABLE AS ROWS.
		for (var i = 0; i < sampleArray.length; i++) {

			tr = table.insertRow(-1);
			for (var j = 0; j < col.length; j++) {
				var tabCell = tr.insertCell(-1);
				tabCell.innerHTML = sampleArray[i][col[j]];
			}
		}

		// FINALLY ADD THE NEWLY CREATED TABLE WITH JSON DATA TO A CONTAINER.
		var divContainer = document.getElementById("sampleData");
		divContainer.innerHTML = "";
		divContainer.appendChild(table);
	}

	$("#file_submit").on("submit",function(e){
		
		e.preventDefault();
		var data = new FormData();
		$.each($('#InputFile')[0].files, function(i, file) {
			data.append('file-'+i, file);
		});
		$('#msg').text('Uploading...')
		$.ajax({
			type: "POST",
			method: "POST",
			url: `${window.location.origin}/v1/file_upload/${$("#InputSample").val()}`,
			cache: false,
			contentType: false,
			processData: false,
			data: data,
			statusCode: {
				200: function(response){
					$('#msg').text(response.msg)
					CreateTableFromJSON(response.rows)
				},
				405: function(response){
					$('#msg').text('Unsuccesful. File not processed.')
				},
				406: function(response){
					$('#msg').text('Unsuccesful. Error reading GeoJson file.')
				},
				407: function(response){
					$('#msg').text('Unsuccesful. Not Valid GeoJson File.')
				},
				401: function(err){
					$('#msg').text('401 Error. See DevTool Console for more details.')
				},
				default: function(response){
					$('#msg').text('Upload successful.')
				}
			},
			success: function(data){
			},
			error: function(err){
				console.log(err)
			}
		})
	})
	
	$("#filter_submit").on("submit",function(e){
		
		e.preventDefault();
		var val = {
			keyname: $('#InputKeyname').val() || 0,
			keyvalue: $('#InputKeyValue').val() || 0,
			limit: $('#InputLimit').val() || 0,
			export: $("input[name='InputExport']:checked").val(),
			tab: $('#InputGeoTab').is(":checked")
		}
		$('#msg').text('Processing...')
		$.ajax({
			type: "POST",
			method: "POST",
			url: `${window.location.origin}/v1/filter/${$("#InputSample").val()}`,
			contentType: 'application/json',
			data: JSON.stringify(val),
			statusCode: {
				200: function(response){
					$('#msg').text(response.msg)
					CreateTableFromJSON(response.rows)
				},
				405: function(response){
					$('#msg').text('Unsuccesful. Keyname not found.')
				},
				406: function(response){
					$('#msg').text('Unsuccesful. Error reading GeoJson file.')
				},
				407: function(response){
					$('#msg').text('Unsuccesful. Not Valid GeoJson File.')
				},
				401: function(err){
					$('#msg').text('401 Error. See DevTool Console for more details.')
				},
				default: function(response){
					$('#msg').text('Successful.')
				}
			},
			success: function(data){
			},
			error: function(err){
				console.log(err)
			}
		})
	})

	$("#exitBtn").on("click",function(){
		$.ajax({
			type: "POST",
			method: "POST",
			url: `${window.location.origin}/v1/exit`,
			statusCode: {
				200: function(response){
					window.close()
				}
			}
		})
	})

</script>
 
  </body>
</html>